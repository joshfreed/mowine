//
//  EditWineWorker.swift
//  mowine
//
//  Created by Josh Freed on 2/18/17.
//  Copyright (c) 2017 BleepSmazz. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so you can apply
//  clean architecture to your iOS and Mac projects, see http://clean-swift.com
//

import UIKit
import CoreData
import JFLib

class EditWineWorker {
    let wineRepository: WineRepository
    let wineTypeRepository: WineTypeRepository
    let imageWorker: WineImageWorker
    let wineImageRepository: WineImageRepository
    
    init(
        wineRepository: WineRepository,
        wineTypeRepository: WineTypeRepository,
        imageWorker: WineImageWorker,
        wineImageRepository: WineImageRepository
    ) {
        self.wineRepository = wineRepository
        self.wineTypeRepository = wineTypeRepository
        self.imageWorker = imageWorker
        self.wineImageRepository = wineImageRepository
    }
    
    func getWineTypes(completion: @escaping (Result<[WineType]>) -> ()) {
        wineTypeRepository.getAll(completion: completion)
    }
    
    func getWinePhoto(wineId: UUID, completion: @escaping (Result<Data?>) -> ()) {
        wineImageRepository.fetchPhoto(wineId: wineId, completion: completion)
    }
    
    func updateWine(wine: Wine, from request: EditWine.SaveWine.Request, completion: @escaping (Result<Wine>) -> ()) {
        wineTypeRepository.getWineType(named: request.type) { result in
            switch result {
            case .success(let newType):
                if let newType = newType {
                    self.updateWineWithType(wine: wine, from: request, newType: newType, completion: completion)
                } else {
                    completion(.failure(EditWineWorkerError.invalidWineType))
                }
            case .failure(let error): completion(.failure(error))
            }
        }
    }
    
    private func updateWineWithType(
        wine: Wine,
        from request: EditWine.SaveWine.Request,
        newType: WineType,
        completion: @escaping (Result<Wine>) -> ()
    ) {
        wine.name = request.name
        wine.rating = request.rating
        wine.location = request.location
        wine.notes = request.notes
        wine.price = request.price
        wine.pairings = request.pairings
        wine.type = newType
        
        if let varietyName = request.variety, let variety = wine.type.getVariety(named: varietyName) {
            wine.variety = variety
        } else {
            wine.variety = nil
        }
        
        wineRepository.save(wine, completion: completion)
    }
    
    func updateWinePhoto(wineId: UUID, photo: UIImage?) -> Data? {
        guard let photo = photo else {
            return nil
        }
        
        guard
            let downsizedImage = imageWorker.resize(image: photo, to: CGSize(width: 400, height: 400)),
            let imageData = imageWorker.toPNG(image: downsizedImage),
            let thumbnailImage = imageWorker.resize(image: photo, to: CGSize(width: 150, height: 150)),
            let thumbnailData = imageWorker.toPNG(image: thumbnailImage)
        else {
            return nil
        }
        
        wineImageRepository.store(wineId: wineId, image: imageData, thumbnail: thumbnailData)
        
        return thumbnailData
    }
}

enum EditWineWorkerError: Error {
    case invalidWineType
}
